## 프록시

### 프록시란?

- 프록시란 ‘대신하다‘라는 의미를 가지고 있는 단어로, 동작을 대신해주는 가짜 객체의 개념
- JPA의 지연로딩을 위해 사용
- 지연 로딩을 하려면 연관된 엔티티의 실제 데이터가 필요할 때 까지 조회를 미뤄함
- 그렇다고 해당 엔티티를 연관관계로 가지고 있는 엔티티의 필드에 null 값을 넣어 둘 수는 없기 때문에 하이버네이트는 지연 로딩을 사용하는 연관관계 자리에 프록시 객체를 주입하여 실제 객체가 들어있는 것처럼 동작하도록 함

### 프록시 사용

- em.find() : **데이터베이스를 통해서 실제 엔티티 객체 조회**
- em.getReference() : 데이터베이스 조회를 미루는 가짜(프록시)엔티티 객체 조회

### 프록시 특징

- 실제 클래스를 상속 받아서 만들어짐 실제 클래스와 겉 모양이 같다.
- 사용하는 입장에서는 진짜 객체인지 프록시 객체인지 구분하지 않고 사용하면 됨(이론상)
- **프록시 객체는 실제 객체의 참조(target)를 보관하여 실제 객체에서 참조된 값을 리턴**
- **프록시 객체를 호출하면 프록시 객체는 실제 객체의 메소드 호출**
- 프록시 객체는 처음 사용할 때 한 번만 초기화!!
- 프록시 객체는 실제 객체로 바뀌는것이 아닌 객체의 참조를 가지고 있기 때문에 실제 엔티티의 객체로 접근하여 값을 가져올 수 있음!
- 프록시 객체는 원본 엔티티를 상속받기 때문에 객체를 비교할 때 `==` 비교를 하지 않고 instance of를 사용해야함
- 영속성 컨텍스트에 찾는 엔티티가 이미 있으면 em.**getReference()**를 호출해도 실제 엔티티 반환
- **영속성 컨텍스트의 도움을 받을 수 없는 준영속 상태일 때, 프록시를 초기화하면 문제 발생**

![Untitled (2)](https://github.com/juhwan-Ki/TIL/assets/87765888/5995ea8b-5fa4-4953-ae2f-39a28b40f722)

### 프록시 객체 초기화

- 프록시 객체는 실제 객체가 필요한 시점에 영속성 컨텍스트로 초기화 요청을 보냄
- 영속성 컨텍스트에서 DB를 조회하여 실제 엔티티를 생성
- 프록시 객체에서 실제 객체(엔티티)에 대한 참조를 가지고 있기 때문에 참조된 객체에서 값을 리턴

![Untitled (3)](https://github.com/juhwan-Ki/TIL/assets/87765888/cf1d677b-6a74-4394-a3ec-09831dcded14)

### 프록시 확인

- 프록시 인스터스의 초기화 여부 확인
    - em.get**PersistenceUnitUtil.isLoaded(Object entity)**
- 프록시 클래스 확인 방법
    - entity.getClass().getName()
- 프록시 강제 초기화
    - Hibernate.initialize(entity)